<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŠ¥ë ¥ ë™ì‚¬ ì›”ë“œì»µ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f4f4f4; margin: 0; padding: 0; }
    #inputArea, #instruction, #tournament, #resultArea { display: none; margin-top: 50px; }
    .input-container { margin-top: 150px; }
    .card { display: inline-block; width: 40%; margin: 20px; padding: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .hidden { display: none; }
    table { margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>

<div id="inputArea" class="input-container">
  <label>í•™ë²ˆ: <input id="studentId"></label>
  <label>ì´ë¦„: <input id="studentName"></label>
  <button onclick="showInstructions()">ë‹¤ìŒ</button>
</div>

<div id="instruction">
  <p>â‘  ì´ ê²Œì„ì€ ì´ìƒí˜• ì›”ë“œì»µ í˜•ì‹ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>
  <p>â‘¡ ì„ íƒí•˜ëŠ” ë™ì‚¬ë¥¼ í´ë¦­í•´ ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì§„ì¶œì‹œì¼œ ì£¼ì„¸ìš”.</p>
  <p>â‘¢ 3ë²ˆê¹Œì§€ ì°¸ì—¬ ê°€ëŠ¥í•˜ë©° ê²°ê³¼ê°€ ì €ì¥ë©ë‹ˆë‹¤.</p>
  <button onclick="startTournament()">ì‹œì‘</button>
</div>

<div id="tournament">
  <h2 id="roundTitle"></h2>
  <div id="matchArea"></div>
</div>

<div id="resultArea">
  <h2>ğŸ“Š ì„ íƒ ê²°ê³¼ ìš”ì•½</h2>
  <table id="summaryTable"></table>
</div>

<script>
  window.addEventListener('DOMContentLoaded', async () => {
    const SUPABASE_URL = 'https://nsfmxmtphiphxevfueua.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZm14bXRwaGlwaHhldmZ1ZXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MzcyNDgsImV4cCI6MjA2NjUxMzI0OH0.N5w7lrlujJq0Jb_CliL0DRqitv3U0TZwyK7s2IcF1NE';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let studentId = '';
    let studentName = '';
    let allWords = [];

    document.getElementById("inputArea").style.display = "block";

    window.showInstructions = function () {
      studentId = document.getElementById("studentId").value.trim();
      studentName = document.getElementById("studentName").value.trim();
      if (!studentId || !studentName) return alert("í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”");
      document.getElementById("inputArea").style.display = "none";
      document.getElementById("instruction").style.display = "block";
    };

    window.startTournament = async function () {
      document.getElementById("instruction").style.display = "none";
      document.getElementById("tournament").style.display = "block";
      const { data, error } = await client.from('wordlist').select();
    
      console.log("ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ìˆ˜:", data?.length);
      
      if (error) return alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      allWords = shuffle(data).slice(0, 64);
      runTournament(allWords);
    };

    function runTournament(entries) {
      const roundTitle = document.getElementById("roundTitle");
      const matchArea = document.getElementById("matchArea");

      const nextRound = [];
      let currentIndex = 0;

      roundTitle.innerText = `${entries.length}ê°•`;

      function showMatch() {
        if (currentIndex >= entries.length) {
          if (nextRound.length === 1) {
            showResult(nextRound[0]);
          } else if (nextRound.length > 1) {
            runTournament(nextRound);
          } else {
            alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
          }
          return;
        }

        const left = entries[currentIndex];
        const right = entries[currentIndex + 1];

        if (!right) {
          nextRound.push(left);
          currentIndex += 2;
          showMatch();
          return;
        }

        matchArea.innerHTML = `
          <div class="card" onclick="choose(${currentIndex})">
            <h3>${left.verb}</h3><p>${left.desc}</p>
          </div>
          <div class="card" onclick="choose(${currentIndex + 1})">
            <h3>${right.verb}</h3><p>${right.desc}</p>
          </div>
        `;

        window.choose = (chosenIndex) => {
          const winner = entries[chosenIndex];
          nextRound.push(winner);
          currentIndex += 2;
          setTimeout(showMatch, 100); // ğŸ’¡ stack overflow ë°©ì§€
        };
      }

      showMatch();
    }

    function showResult(winner) {
      document.getElementById("tournament").style.display = "none";
      document.getElementById("resultArea").style.display = "block";

      const quarters = allWords.slice(0, 8).filter(w => w.id !== winner.id).map(w => w.verb);
      const semis = allWords.slice(0, 4).filter(w => w.id !== winner.id).map(w => w.verb);
      const finals = allWords.slice(0, 2).filter(w => w.id !== winner.id).map(w => w.verb);

      const table = document.getElementById("summaryTable");
      table.innerHTML = `
        <tr><th>ğŸ† ìµœì¢… ìš°ìŠ¹</th><td>${winner.verb}</td></tr>
        <tr><th>ê²°ìŠ¹ ì§„ì¶œ (ì„ íƒ ì•ˆë¨)</th><td>${finals.join(', ')}</td></tr>
        <tr><th>4ê°• ì§„ì¶œ (ì„ íƒ ì•ˆë¨)</th><td>${semis.join(', ')}</td></tr>
        <tr><th>8ê°• ì§„ì¶œ (ì„ íƒ ì•ˆë¨)</th><td>${quarters.join(', ')}</td></tr>
      `;

      saveResult(winner.verb, finals.join(', '), semis.join(', '), quarters.join(', '));
    }

    async function saveResult(final, finals, semis, quarters) {
      const { error } = await client.from('responses').insert([{
        student_id: studentId,
        student_name: studentName,
        round_num: 1,
        final,
        finals,
        semis,
        quarters
      }]);
      if (error) alert("ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜");
    }

    function shuffle(array) {
      let arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
  });
</script>

</body>
</html>
