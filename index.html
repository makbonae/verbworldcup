<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŠ¥ë ¥ ë™ì‚¬ ì›”ë“œì»µ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f4f4f4; margin: 0; padding: 0; }
    #inputArea, #instruction, #tournament, #resultArea, #pdfButton, #nextRoundArea, #roundLoading { display: none; margin-top: 50px; }
    .input-container { display: flex; flex-direction: column; align-items: center; margin-top: 100px;}
    .input-container label { display: block; font-size: 24px; height: 40px; margin-bottom: 12px;}
    .input-container input {font-size: 24px; height: 40px; margin-bottom: 12px;}
    .input-container button {font-size: 24px; height: 40px; padding: 1px 10px;}
    .card-container { display: flex; gap: 20px;}
    .card { flex: 1; padding: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; flex-direction: column;}
    table { margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    .round-summary { border: 2px solid #333; margin: 30px auto; width: 80%; background: #fff; padding: 20px; }
    .round-summary h3 { margin-bottom: 10px; }
    .center-container {min-height: 100vh; display: flex; justify-content: center; align-items: center; }

    #pdfButton button, #nextRoundBtn {
      font-size: 18px; padding: 10px 30px; margin-top: 20px;
    }
    /* ğŸŒ€ ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
    .spinner {
      margin: 0 auto;
      border: 12px solid #f3f3f3;
      border-top: 12px solid #3498db;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div id="inputArea" class="input-container">
  <label for="studentId">í•™ë²ˆ: <input id="studentId" type="text"></label>
  <label for="studentName">ì´ë¦„: <input id="studentName" type="text"></label>
  <button style=" padding: 1px 10px;" onclick="showInstructions()">ë‹¤ìŒ</button>
</div>

<div id="instruction" style="text-align: left; padding: 1.5em;">
  <p style="font-size: 28px;">â‘  ì´ ê²Œì„ì€ ì´ìƒí˜• ì›”ë“œì»µ í˜•ì‹ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>
  <p style="font-size: 28px;">â‘¡ ì„ íƒí•˜ëŠ” ë™ì‚¬ë¥¼ í´ë¦­í•´ ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì§„ì¶œì‹œì¼œ ì£¼ì„¸ìš”.</p>
  <p style="font-size: 28px;">â‘¢ ì´ 3íšŒê¹Œì§€ ì°¸ì—¬í•  ìˆ˜ ìˆìœ¼ë©°, ê° ê²°ê³¼ëŠ” ì €ì¥ë©ë‹ˆë‹¤.</p>
  <p> </p>
  <button style="height:40px; font-size:24px; padding: 1px 10px;" onclick="startTournament()">ì‹œì‘</button>
</div>

<!-- ğŸŒ€ ë¡œë”© í™”ë©´ -->

<div id="roundLoading">
  <div class="spinner"></div>
  <p id="loadingText" style="font-size:32px; font-weight:bold; margin-top:20px;"></p>
</div>

<div id="tournament">
  <h2 id="roundTitle"></h2>
  <div id="matchArea"></div>
</div>

<div id="resultArea">
  <h2>ğŸ“Š ì„ íƒ ê²°ê³¼ ìš”ì•½</h2>
  <div id="summaryWrapper"></div>
</div>

<div id="nextRoundArea">
  <button id="nextRoundBtn" class="next-round-btn">ğŸ‘‰ ê²°ê³¼ ì €ì¥í•˜ê³  í•œ ë²ˆ ë”! (2íšŒì°¨)</button>
</div>

<div id="pdfButton">
  <button onclick="downloadPDF()">ğŸ“„ ê²°ê³¼ PDF ì €ì¥</button>
</div>

<script>
  const SUPABASE_URL = 'https://nsfmxmtphiphxevfueua.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZm14bXRwaGlwaHhldmZ1ZXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MzcyNDgsImV4cCI6MjA2NjUxMzI0OH0.N5w7lrlujJq0Jb_CliL0DRqitv3U0TZwyK7s2IcF1NE'; // ë³´ì•ˆì„ ìœ„í•´ ì‹¤ì œ ì‚¬ìš© ì‹œ í™˜ê²½ë³€ìˆ˜ë¡œ
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let studentId = '', studentName = '', allWords = [];
  let resultsByRound = [], roundCount = 1;

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById("inputArea").style.display = "block";
  });

  window.showInstructions = function () {
    studentId = document.getElementById("studentId").value.trim();
    studentName = document.getElementById("studentName").value.trim();
    if (!studentId || !studentName) return alert("í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”");
    document.getElementById("inputArea").style.display = "none";
    document.getElementById("instruction").style.display = "block";
  };

  window.startTournament = async function () {
    document.querySelectorAll(".round-summary").forEach(el => el.style.display = 'none');
    document.getElementById("inputArea").style.display = "none";
    document.getElementById("instruction").style.display = "none";
    document.getElementById("tournament").style.display = "none";
    document.getElementById("resultArea").style.display = "none";
    document.getElementById("pdfButton").style.display = "none";
    document.getElementById("nextRoundArea").style.display = "none";

    const { data, error } = await client.from('wordlist').select();
    if (error) return alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

    allWords = shuffle(data).slice(0, 64);
    resultsByRound = [];
    runTournament(allWords);
  };

  function runTournament(entries) {
    const roundTitle = document.getElementById("roundTitle");
    const matchArea = document.getElementById("matchArea");
    const nextRound = [];
    let currentIndex = 0;
    const roundResults = [];

    const roundName = entries.length === 2 ? 'ê²°ìŠ¹' : `${entries.length}ê°•`;

    // ğŸŒ€ ë¡œë”© í™”ë©´ë§Œ í‘œì‹œ
    document.getElementById("inputArea").style.display = "none";
    document.getElementById("instruction").style.display = "none";
    document.getElementById("tournament").style.display = "none";
    document.getElementById("resultArea").style.display = "none";
    document.getElementById("pdfButton").style.display = "none";
    document.getElementById("nextRoundArea").style.display = "none";

    document.getElementById("loadingText").innerText = `${roundName} ë¡œë”© ì¤‘...`;
    document.getElementById("roundLoading").style.display = "block";

    setTimeout(() => {
      document.getElementById("roundLoading").style.display = "none";
      document.getElementById("tournament").style.display = "block";
      roundTitle.innerText = roundName;
      showMatch();
    }, 2000);

    function showMatch() {
      if (currentIndex >= entries.length) {
        resultsByRound.push(roundResults);
        if (nextRound.length === 1) {
          showResult(nextRound[0]);
        } else {
          runTournament(nextRound);
        }
        return;
      }

      const left = entries[currentIndex];
      const right = entries[currentIndex + 1];

      if (!right) {
        nextRound.push(left);
        currentIndex += 2;
        showMatch();
        return;
      }

      matchArea.innerHTML = `
        <div class="card-container">,
          <div class="card" onclick="choose(${currentIndex})">
            <h3 style="font-size: 48px;">${left.verb}</h3><p style="font-size: 24px;">${left.desc}</p>
          </div>
          <div class="card" onclick="choose(${currentIndex + 1})">
            <h3 style="font-size: 48px;">${right.verb}</h3><p style="font-size: 24px;">${right.desc}</p>
          </div>
        </div>
      `;

      window.choose = (chosenIndex) => {
        const winner = entries[chosenIndex];
        const loser = entries[chosenIndex === currentIndex ? currentIndex + 1 : currentIndex];
        nextRound.push(winner);
        roundResults.push({ winner, loser });
        currentIndex += 2;
        setTimeout(showMatch, 100);
      };
    }
  }

  function showResult(winner) {
    document.getElementById("tournament").style.display = "none";
    document.getElementById("resultArea").style.display = "block";
    document.querySelectorAll(".round-summary").forEach(el => el.style.display = 'block');

    function getLosers(roundIndex) {
      const round = resultsByRound.at(roundIndex) || [];
      return [...new Set(round.map(r => r.loser).filter(w => w.id !== winner.id).map(w => w.verb))];
    }

    const finals = getLosers(-1);
    const semis = getLosers(-2);
    const quarters = getLosers(-3);

    const summary = document.createElement("div");
    summary.className = "round-summary";
    summary.setAttribute("data-round", roundCount);
    summary.innerHTML = `
      <h3>ğŸ”¹ ${roundCount}íšŒì°¨ ê²°ê³¼</h3>
      <table>
        <tr><th>ğŸ† ìµœì¢… ìš°ìŠ¹</th><td>${winner.verb}</td></tr>
        <tr><th>ê²°ìŠ¹ ì§„ì¶œ</th><td>${finals.join(', ') || 'ì—†ìŒ'}</td></tr>
        <tr><th>4ê°• ì§„ì¶œ</th><td>${semis.join(', ') || 'ì—†ìŒ'}</td></tr>
        <tr><th>8ê°• ì§„ì¶œ</th><td>${quarters.join(', ') || 'ì—†ìŒ'}</td></tr>
      </table>
    `;
    document.getElementById("summaryWrapper").appendChild(summary);
    saveResult(winner.verb, finals.join(', '), semis.join(', '), quarters.join(', '));

    const nextBtn = document.getElementById("nextRoundBtn");
    const nextArea = document.getElementById("nextRoundArea");

    if (roundCount < 3) {
      nextBtn.innerText = `ğŸ‘‰ ê²°ê³¼ ì €ì¥í•˜ê³  í•œ ë²ˆ ë”! (${roundCount + 1}íšŒì°¨)`;
      nextBtn.onclick = () => {
        roundCount++;
        startTournament();
      };
      nextArea.style.display = "block";
    } else {
      nextArea.style.display = "none";
      document.getElementById("pdfButton").style.display = "block";
    }
  }

  async function saveResult(final, finals, semis, quarters) {
    const { error } = await client.from('responses').insert([{
      student_id: studentId,
      student_name: studentName,
      round_num: roundCount,
      final,
      finals,
      semis,
      quarters
    }]);
    if (error) alert("ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜");
  }

  window.downloadPDF = async () => {
    const { jsPDF } = window.jspdf;

    const element = document.getElementById("resultArea");

    const canvas = await html2canvas(element, {
      scale: 1, // í•´ìƒë„ ê°œì„ 
      useCORS: true,
      allowTaint: true,
      scrollY: -window.scrollY // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¡œ ì¸í•œ ì˜ë¦¼ ë°©ì§€
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${studentId}_${studentName}_ëŠ¥ë ¥ë™ì‚¬ ì›”ë“œì»µ_ê²°ê³¼.pdf`);
  };


  function shuffle(array) {
    let arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
</script>

</body>
</html>
