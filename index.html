<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>능력 동사 월드컵</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f4f4f4; margin: 0; padding: 0; }
    #inputArea, #instruction, #tournament, #resultArea, #repeatButton, #pdfButton, #roundNotice { display: none; margin-top: 50px; }
    .input-container { margin-top: 150px; }
    .card { display: inline-block; width: 40%; margin: 20px; padding: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .hidden { display: none; }
    table { margin: 20px auto 60px auto; border-collapse: collapse; width: 80%; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th[colspan] { background: #f0f0f0; }
    #roundNotice h1 { font-size: 48px; margin: 100px auto; color: #333; }
  </style>
</head>
<body>

<div id="inputArea" class="input-container">
  <label>학번: <input id="studentId"></label>
  <label>이름: <input id="studentName"></label>
  <button onclick="showInstructions()">다음</button>
</div>

<div id="instruction">
  <p>① 이 게임은 이상형 월드컵 형식으로 진행됩니다.</p>
  <p>② 선택하는 동사를 클릭해 다음 라운드로 진출시켜 주세요.</p>
  <p>③ 3번까지 참여 가능하며 결과가 저장됩니다.</p>
  <button onclick="startTournament()">시작</button>
</div>

<div id="roundNotice">
  <h1 id="noticeText"></h1>
</div>

<div id="tournament">
  <h2 id="roundTitle"></h2>
  <div id="matchArea"></div>
</div>

<div id="resultArea">
  <h2>📊 선택 결과 요약</h2>
  <div id="summaryContainer"></div>
  <div id="repeatButton">
    <button onclick="startTournament()">한 번 더 진행하기</button>
  </div>
  <div id="pdfButton">
    <button onclick="downloadPDF()">📄 PDF 저장하기</button>
  </div>
</div>

<script>
  window.addEventListener('DOMContentLoaded', async () => {
    const SUPABASE_URL = 'https://nsfmxmtphiphxevfueua.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZm14bXRwaGlwaHhldmZ1ZXVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MzcyNDgsImV4cCI6MjA2NjUxMzI0OH0.N5w7lrlujJq0Jb_CliL0DRqitv3U0TZwyK7s2IcF1NE';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let studentId = '';
    let studentName = '';
    let allWords = [];
    let roundCount = 0;
    let history = [];

    document.getElementById("inputArea").style.display = "block";

    window.showInstructions = function () {
      studentId = document.getElementById("studentId").value.trim();
      studentName = document.getElementById("studentName").value.trim();
      if (!studentId || !studentName) return alert("학번과 이름을 입력해 주세요");
      document.getElementById("inputArea").style.display = "none";
      document.getElementById("instruction").style.display = "block";
    };

    window.startTournament = async function () {
      if (roundCount >= 3) return alert("최대 3번까지만 참여할 수 있습니다.");

      document.getElementById("instruction").style.display = "none";
      document.getElementById("resultArea").style.display = "none";
      document.getElementById("tournament").style.display = "none";
      document.getElementById("repeatButton").style.display = "none";
      document.getElementById("pdfButton").style.display = "none";

      const { data, error } = await client.from('wordlist').select();
      if (error) return alert("데이터 불러오기 실패");

      allWords = shuffle(data).slice(0, 64);
      history = [{ stage: 64, entries: [...allWords] }];
      runTournament(allWords);
    };

    function runTournament(entries) {
      const roundTitle = document.getElementById("roundTitle");
      const matchArea = document.getElementById("matchArea");
      const roundNotice = document.getElementById("roundNotice");
      const noticeText = document.getElementById("noticeText");

      const nextRound = [];
      let currentIndex = 0;

      const roundLabel = entries.length === 2 ? "결승" : `${entries.length}강`;
      roundTitle.innerText = roundLabel;

      roundNotice.style.display = "block";
      noticeText.innerText = roundLabel;

      setTimeout(() => {
        roundNotice.style.display = "none";
        document.getElementById("tournament").style.display = "block";
        showMatch();
      }, 2000);

      function showMatch() {
        if (currentIndex >= entries.length) {
          if (nextRound.length === 1) {
            showResult(nextRound[0]);
          } else {
            history.push({ stage: nextRound.length, entries: [...nextRound] });
            runTournament(nextRound);
          }
          return;
        }

        const left = entries[currentIndex];
        const right = entries[currentIndex + 1];

        if (!right) {
          nextRound.push(left);
          currentIndex += 2;
          showMatch();
          return;
        }

        matchArea.innerHTML = `
          <div class="card" onclick="choose(${currentIndex})">
            <h3>${left.verb}</h3><p>${left.desc}</p>
          </div>
          <div class="card" onclick="choose(${currentIndex + 1})">
            <h3>${right.verb}</h3><p>${right.desc}</p>
          </div>
        `;

        window.choose = (chosenIndex) => {
          const winner = entries[chosenIndex];
          nextRound.push(winner);
          currentIndex += 2;
          setTimeout(showMatch, 100);
        };
      }
    }

    // ... 생략된 기존 showResult, saveResult, shuffle, downloadPDF 등 함수 그대로 유지

  });
</script>
</body>
</html>
